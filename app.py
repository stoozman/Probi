import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import joblib

# Загрузка модели и скалера
model = joblib.load('logistic_regression_model.joblib')
scaler = joblib.load('scaler.joblib')

# Названия признаков
features = ['ALB', 'BUN', 'A/G', 'GLU', 'GLO', 'BUN|CRE', 'TBIL', 'Na+', 'P', 'AMY']

# Описания признаков
feature_descriptions = {
    'ALB': 'Уровень альбумина в крови',
    'BUN': 'Концентрация уреи в крови',
    'A/G': 'Соотношение альбумина к глобулинам',
    'GLU': 'Уровень глюкозы в крови',
    'GLO': 'Уровень глобулинов в крови',
    'BUN|CRE': 'Соотношение уреи к креатинину',
    'TBIL': 'Уровень общего билирубина',
    'Na+': 'Уровень натрия в крови',
    'P': 'Уровень фосфора в крови',
    'AMY': 'Уровень амилазы в крови'
}

# Заголовок приложения
st.title("Прогнозирование эффекта от введения продукта")
st.subheader("Анализ влияния на биохимические параметры у крупного рогатого скота")

# Описание приложения
st.markdown("""
Это приложение демонстрирует, как введение нашего продукта влияет на биохимические параметры у крупного рогатого скота.
Введите текущие значения параметров животного, чтобы получить прогноз после применения препарата.
""")

# Функция предсказания
def predict_product_effect(input_data):
    input_data_scaled = scaler.transform(input_data)
    prediction = model.predict(input_data_scaled)
    probability = model.predict_proba(input_data_scaled)
    return prediction, probability

# Интерфейс ввода данных
st.subheader("Введите текущие значения параметров:")

# Создаем форму для ввода данных
user_input = {}
for feature in features:
    with st.expander(f"{feature} - {feature_descriptions[feature]}"):
        user_input[feature] = st.number_input(feature, key=feature)

# Формирование DataFrame из введенных данных
input_df = pd.DataFrame([user_input])

# Кнопка для выполнения предсказания
if st.button('Предсказать эффект'):
    # Выполнение предсказания
    prediction, probability = predict_product_effect(input_df)
    
    # Вывод результатов
    st.subheader("Результаты прогноза:")
    
    if prediction[0] == 1:
        st.success("Прогнозируется положительный эффект от введения продукта!")
        st.write(f"Вероятность эффекта: {probability[0][1]:.2f}")
    else:
        st.warning("Прогнозируется отсутствие эффекта от введения продукта.")
        st.write(f"Вероятность отсутствия эффекта: {probability[0][0]:.2f}")
    
    # Визуализация коэффициентов модели
    st.subheader("Влияние параметров на прогноз:")
    coefficients = pd.Series(model.coef_[0], index=features)
    coefficients_sorted = coefficients.sort_values(ascending=False)
    
    fig, ax = plt.subplots(figsize=(10, 6))
    coefficients_sorted.plot(kind='bar', ax=ax)
    plt.title('Влияние параметров на прогноз (коэффициенты модели)')
    plt.xlabel('Параметры')
    plt.ylabel('Коэффициент')
    st.pyplot(fig)
    
    # Интерпретация коэффициентов
    st.write("Положительные коэффициенты увеличивают вероятность эффекта продукта, отрицательные - уменьшают.")
    st.write("Наибольшее влияние оказывают параметры с наибольшей по модулю величиной коэффициента.")

# Добавляем информацию о параметрах
st.markdown("---")
st.subheader("Информация о параметрах")
for feature in features:
    st.write(f"**{feature}** - {feature_descriptions[feature]}")

# Добавляем информацию о модели
st.markdown("---")
st.subheader("Информация о модели")
st.markdown("""
Модель построена на основе логистической регрессии с взвешиванием классов.
Она обучена на исторических данных с использованием следующих параметров:
- Кросс-валидация: 5-кратная стратифицированная
- Средний AUC-ROC на кросс-валидации: 0.88
- Точность на тестовой выборке: 0.625
- AUC-ROC на тестовой выборке: 0.75
""")

# Добавляем информацию о применении
expander = st.expander("Показать рекомендации по применению продукта")
expander.markdown("""
**Рекомендации по применению продукта:**

1. **Дозировка**: согласно инструкции производителя (обычно рассчитывается на кг веса животного)
2. **Периодичность**: предпочтительно в периоды повышенной метаболической нагрузки
3. **Противопоказания**: не рекомендуется для животных с критически низкими уровнями альбумина (<30 г/л)
4. **Мониторинг**: рекомендуется контрольное измерение биохимических показателей через 10-14 дней после начала применения

**Экономический эффект**: Применение продукта в рекомендуемых дозах способствует оптимизации обменных процессов, что может привести к улучшению продуктивных показателей животных.
""")

# Добавляем сноску
st.markdown("---")
st.markdown("© 2025 | Информация предназначена только для демонстрационных целей в ветеринарии")